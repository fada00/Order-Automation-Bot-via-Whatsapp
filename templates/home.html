<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ODTÃœ Maydonoz DÃ¶ner</title>
    <link rel="stylesheet" href="/static/styles_home.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.js"></script>
</head>
<body>
    <header>
        <div class="logo">
            <h1>ODTÃœ MAYDONOZ DÃ–NER</h1>
        </div>
        <nav>
            <a href="/">SÄ°PARÄ°ÅžLER</a>
            <a href="/menus">MENÃœLER</a>
        </nav>
    </header>
    <main>
        <div class="order-grid" id="orders-container">
            {% for order_id, order in orders.items() %}
            <div class="order-card">
                <h2>
                    <span>{{ order.customer_name }}</span>
                    <span class="order-id">Sip. No: {{ order_id }}</span>
                </h2>
                <p><strong>Telefon NumarasÄ±:</strong> {{ order.phone }}</p>
                <hr>
                <p><strong>SipariÅŸ Saati:</strong> {{ order.date }}</p>
                <p><strong>SipariÅŸ DetaylarÄ±:</strong></p>
                <ul>
                    {% for item in order.itemss %}
                    <li>{{ item }}</li>
                    {% endfor %}
                </ul>
                <hr>
                <p><strong>Adres:</strong> {{ order.address }}</p>
                <p><strong>Toplam Tutar:</strong> {{ order.total }} TL</p>
                <p><strong>Ã–deme YÃ¶ntemi:</strong> {{ order.payment }}</p>
                <hr>
                <div class="buttons">
                    <button
                        class="status-button preparing"
                        onclick="updateOrderStatus({{ order['id'] }}, 'hazÄ±rlanÄ±yor')"
                        {% if order['status'] == 'hazÄ±rlanÄ±yor' %}style="background-color: green; color: white;"{% endif %}>
                        HAZIRLANIYOR
                    </button>
                    <button
                        class="status-button on-the-way"
                        onclick="updateOrderStatus({{ order['id'] }}, 'yolda')"
                        {% if order['status'] == 'yolda' %}style="background-color: green; color: white;"{% endif %}>
                        YOLDA
                    </button>
                    <button
                        class="status-button delivered"
                        onclick="updateOrderStatus({{ order['id'] }}, 'teslim edildi')"
                        {% if order['status'] == 'teslim edildi' %}style="background-color: green; color: white;"{% endif %}>
                        TESLÄ°M EDÄ°LDÄ°
                    </button>
                    <button
                        class="status-button cancel"
                        onclick="updateOrderStatus({{ order['id'] }}, 'iptal edildi')"
                        {% if order['status'] == 'iptal edildi' %}style="background-color: red; color: white;"{% endif %}>
                        Ä°PTAL ET
                    </button>
                </div>
                <p class="status-text"><strong>SipariÅŸ Durumu:</strong> {{ order.status }}</p>
            </div>
            {% endfor %}
        </div>
    </main>
    <script>
        function updateOrderStatus(orderId, newStatus) {
            fetch('/update-order-status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ order_id: orderId, status: newStatus }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload(); // SayfayÄ± yenileyerek yeni durumlarÄ± gÃ¶stermek iÃ§in
                } else {
                    alert('GÃ¼ncelleme sÄ±rasÄ±nda bir hata oluÅŸtu.');
                }
            })
            .catch(error => console.error('Error:', error));   
        }

        function updateOrderList(orders) {
            const ordersContainer = document.getElementById("orders-container");
            ordersContainer.innerHTML = ""; // ðŸ“Œ Ã–nce mevcut sipariÅŸleri temizle
            // Mevcut sipariÅŸleri gÃ¼ncelle
            Object.values(orders).forEach(order => {
                let orderHtml = `
                    <div class="order-card">
                        <h2>
                            <span>${order.customer_name}</span>
                            <span class="order-id">Sip. No: ${order.id}</span>
                        </h2>
                        <p><strong>Telefon NumarasÄ±:</strong> ${order.phone}</p>
                        <hr>
                        <p><strong>SipariÅŸ Saati:</strong> ${order.date}</p>
                        <p><strong>SipariÅŸ DetaylarÄ±:</strong></p>
                        <ul>${order.itemss.map(item => `<li>${item}</li>`).join('')}</ul>
                        <hr>
                        <p><strong>Adres:</strong> ${order.address}</p>
                        <p><strong>Toplam Tutar:</strong> ${order.total} TL</p>
                        <p><strong>Ã–deme YÃ¶ntemi:</strong> ${order.payment}</p>
                        <hr>
                        <div class="buttons">
                            <button class="status-button preparing"
                                onclick="updateOrderStatus(${order.id}, 'hazÄ±rlanÄ±yor')"
                                ${order.status === 'hazÄ±rlanÄ±yor' ? 'style="background-color: green; color: white;"' : ''}>
                                HAZIRLANIYOR
                            </button>
                            <button class="status-button on-the-way"
                                onclick="updateOrderStatus(${order.id}, 'yolda')"
                                ${order.status === 'yolda' ? 'style="background-color: green; color: white;"' : ''}>
                                YOLDA
                            </button>
                            <button class="status-button delivered"
                                onclick="updateOrderStatus(${order.id}, 'teslim edildi')"
                                ${order.status === 'teslim edildi' ? 'style="background-color: green; color: white;"' : ''}>
                                TESLÄ°M EDÄ°LDÄ°
                            </button>
                            <button class="status-button cancel"
                                onclick="updateOrderStatus(${order.id}, 'iptal edildi')"
                                ${order.status === 'iptal edildi' ? 'style="background-color: red; color: white;"' : ''}>
                                Ä°PTAL ET
                            </button>
                        </div>
                        <p class="status-text"><strong>SipariÅŸ Durumu:</strong> ${order.status}</p>
                    </div>
                `;
                ordersContainer.insertAdjacentHTML('beforeend', orderHtml);
            });
        }

        const socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port);

        // Zil sesi dosyasÄ±nÄ± tanÄ±mla
        const notificationSound = new Audio('/static/ding_gooog.mp3');

        // Yeni sipariÅŸ geldiÄŸinde sesi Ã§al
        socket.off("new_order");
        socket.on("new_order", function(data) {
            console.log("Yeni sipariÅŸ alÄ±ndÄ±!", data);
            notificationSound.play(); // Zil sesini Ã§al
            updateOrderList(data.orders); // SipariÅŸ listesini gÃ¼ncelle
        });

        // Sayfa yÃ¼klendiÄŸinde mevcut sipariÅŸleri getir
        fetch('/get-orders')
            .then(response => response.json())
            .then(data => updateOrderList(data))
            .catch(error => console.error("SipariÅŸleri getirirken hata oluÅŸtu:", error));
            
            document.addEventListener("click", function enableAudio() {
        notificationSound.play()
            .then(() => console.log("Ses izni alÄ±ndÄ±, artÄ±k otomatik Ã§alabilir."))
            .catch(error => console.warn("Ses izni alÄ±namadÄ±:", error));
    
        document.removeEventListener("click", enableAudio); // Tek seferlik izin al
});
    </script>
</body>
</html>